I"X<p>En esta ocasión, vamos a configurar Rsyslog para que recolecte cualquier log que le indiquemos. Esto es muy útil si tenemos un aplicación propia que genere logs o cualquier otra aplicación como puede ser Tomcat, por ejemplo, además de ser fácil de implementar (una vez te has peleado con ello).</p>

<h2 id="fichero-configuración">Fichero configuración</h2>

<p>Vamos a crear el fichero de configuración necesario en el cliente para que mande los logs al servidor central. El servidor central debe estar configurado como indicamos en <a href="https://www.samurantech.com/configurar-rsyslog-central-linux/">este post</a>.<br />
Una vez hecho eso, vamos al grano.</p>

<p>Antes de crear el fichero, tenemos que crear el directorio de trabajo para rsyslog, en este caso <code class="language-plaintext highlighter-rouge">/var/spool/rsyslog</code>. El comando para ello es:<br />
<code class="language-plaintext highlighter-rouge">mkdir /var/spool/rsyslog</code></p>

<p>Creamos un fichero llamado <code class="language-plaintext highlighter-rouge">&lt;aplicacion&gt;.conf</code>, podéis ponerle el nombre que queráis, dentro de <code class="language-plaintext highlighter-rouge">/etc/rsyslog.d/</code> con el siguiente contenido:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ModLoad imfile
$InputFilePollInterval 10
$WorkDirectory /var/spool/rsyslog

$template Rfc5424Format,"&lt;%PRI%&gt;1 %TIMESTAMP:::date-rfc3339% %HOSTNAME% %APP-NAME% %PROCID% %MSGID% %STRUCTURED-DATA% %msg%"

$InputFileName &lt;/ruta/fichero&gt;
$InputFileTag &lt;aplicacion&gt;-log
$InputFileStateFile stat-&lt;aplicacion&gt;-log
$InputFileSeverity info
$InputFilePersistStateInterval 20000
$InputRunFileMonitor
if $programname == '&lt;aplicacion&gt;-log' then @@&lt;ip_servidor&gt;:514;Rfc5424Format
if $programname == '&lt;aplicacion&gt;-log' then stop
</code></pre></div></div>

<p>A primera vista esto asusta un poco, pero vamos a ir desglosando que función tiene cada línea del fichero.</p>

<p>Los siguientes parametros son globales.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$ModLoad imfile</code> carga el módulo de rsyslog. Lee línea a línea el fichero que le pasemos como parametro.</li>
  <li><code class="language-plaintext highlighter-rouge">$InputFilePollInterval</code> especifica la frecuencia con la que comprueba los archivos para obtener nuevos datos.</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$WorkDirectory</code> el directorio de trabajo de rsyslog. Aquí se guardan los llamados <em>state file</em>, que contienen temporalmente los nuevos datos que se recogen para ser enviados.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">$template</code> el formato en el que se van a mandar los logs al servidor. Esta parte es muy importante, porque probando distintos formatos, me ha llegado a crear un fichero por cada línea que se recogía en el fichero.</li>
</ul>

<p>Estos parametros son especificos para el archivo con que vamos a trabajar.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$InputFileName</code> el fichero que queremos que recolecte la información y envíe.</li>
  <li><code class="language-plaintext highlighter-rouge">$InputFileTag</code> el nombre del fichero que se creará en el servidor y donde se mandará la información.</li>
  <li><code class="language-plaintext highlighter-rouge">$InputFileStateFile</code> el nombre de los <em>state files</em> mencionados antes.</li>
  <li><code class="language-plaintext highlighter-rouge">$InputFileSeverity</code> la severidad que se le asigna a las líneas que lee.</li>
  <li><code class="language-plaintext highlighter-rouge">$InputFilePersistStateInterval</code> especifica la frecuencia con la que se escribirá el archivo de estado al procesar el archivo de entrada. Esta configuración se puede utilizar para evitar duplicidad de mensajes por errores como un corte de energía.</li>
  <li><code class="language-plaintext highlighter-rouge">$InputRunFileMonitor</code> activa que se monitorice el fichero.</li>
</ul>

<p>Las dos últimas 2 líneas indican que si les llega una petición de tratar el fichero con el tag indicado, lo manden a un servidor por TCP (2 @ indica TCP, 1 @ por UDP) aplicando el formato que hemos definido.</p>

<p><strong>IMPORTANTE.</strong> Si estáis trabajando con CentOS y tenéis el SELinux activado, tenéis que cambiar el tipo del fichero por <code class="language-plaintext highlighter-rouge">var_log_t</code> con el comando:</p>

<p><code class="language-plaintext highlighter-rouge">chcon -t var_log_t &lt;fichero&gt;</code></p>

<p>Tenéis que tener en cuenta que si la carpeta se encuentra fuera de <code class="language-plaintext highlighter-rouge">/var/log</code> también tenéis que cambiarle el tipo a dicha carpeta, porque si no rsyslog no podrá acceder a ella.</p>

<p>Puedes jugar bastante con Rsyslog y todas las posibilidades que te ofrece, facilitando mucho el trabajo cuando tienes que revisar muchos logs de distintos servidores.</p>

<p>Espero que os haya gustado y os haya servido de ayuda. ¡Hasta la próxima!</p>

:ET